<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="Styless.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Spa Web Cliente</title>
</head>

<body>
  <a href="../../Index.html">
  <img id = "logo"  height="85px" width="85px" src="../../Recursos/Logos/logo.png" alt=""> 
  </a>
    <div class="topItem">
      <h1 id="titulo">Spa California App - Cliente</h1>
        <div class="float-right">
            <div> 
                <p id="nombre_usuario" class="nombre_usuario"> Bienvenido</p>
            </div>
        </div>
    </div>

    <div id="wrapper">
        <div style="margin-left: 0px ;" class="col-7" id="second">
            <div class="container">

                <div class="text-center mt-5">
                    <h2>Formulario de Registro</h2>
                </div>

            <div class="row">
                <div class="col-lg-15 mx-auto">
                    <div class="card mt-2 mx-auto p-2 bg-light">
                        <div class="card-body bg-light">
                            <div class="container">
                                <form id="formReserva" method="post">

                                    <div class="controls">
                                        <div class="row">
                                            <div class="col-md-7">
                                                <div class="form-group">
                                                    <label for="form_name">Seleccione la sucursal en la que desea hacer la reserva *</label>
                                                    <select id="cmbSucursales" name="id_sucursal" class="form-control" required data-error="Please specify your need.">
                                                      <option value="" selected>-- Seleccione una sucursal --</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label for="form_name">Servicio *</label>
                                                    <select id="cmbServicios" name="id_servicio" disabled class="form-control" required data-error="Por favor, seleccione un servicio.">
                                                      <option value="" selected disabled>Seleccione el servicio</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label for="precio">Precio ($)</label>
                                                    <input type="number" id="precio" name="precio" disabled class="form-control"
                                                        required min="0" value="1" step=".01">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label for="fotografia">Imagen del servicio:</label>
                                                    <img id="imgServicio" width="150px" height="150px" alt="" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="dateDiaReserva">Selecciona el dia *</label>
                                                    <input type="date" id="dateDiaReserva" name="dia_reserva" disabled>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label for="cmbHorarioReserva">Selecciona el horario *</label>
                                                    <select id="cmbHorarioReserva" name="horario_reserva" class="form-control"
                                                        disabled required data-error="Por favor, seleccione un servicio.">
                                                        <option value="" selected disabled>Seleccione la hora</option>
                                                        <option value="1">Mañana (9h00 a 13h00)</option>
                                                        <option value="2">Tarde (14h00 a 18h00)</option>
                                                        <option value="3">Noche (18h00 a 21h00)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">

                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="descripcion">Descripción *</label>
                                                    <textarea id="descripcion" name="descripcion" disabled class="form-control" resize="vertical"
                                                                placeholder="Escriba la descripción del servicio." rows="4"
                                                                    data-error="Please, leave us a message."></textarea>
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2 col-6 mx-auto">
                                                <!-- <input id="guardarServicio" type="button" -->
                                                <input id="guardarServicio" type="submit"
                                                    class="btn btn-success btn-send pt-2 btn-block "
                                                        value="Agregar Servicio" disabled>
                                                
                                            </div>

                                            <br>
                                            <br>
                                            <br>
                                            <p><b>*Nota: Los días sábados solo tendremos atención hasta la tarde,
                                                y los domingos no habrá atención.</b></p>

                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div> <!-- /.8 -->
                </div> <!-- /.row-->
            </div>
            </div>
   
        </div>
        <div class="col-5" id="first">
                
                <br>
                <br>
            <input type="hidden" id="total_reserva">

            <center><h3>Servicios Reservados</h3></center>

            <div class="table-responsive">
                <table id="tblServicios" class="table">
                    <thead>
                        <tr>
                            <th style="display: none;" scope="col">#</th>
                            <th width="30%" scope="col">Servicio</th>
                            <th width="20%" scope="col">Precio ($)</th>
                            <th width="50%" scope="col">Horario</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

                <br>
                <br>
                <br>

            <div>
                <div class="divPrecio">Precio:</div>
                <div id="divPrecioTotal" class="divPrecio">$0.00</div>
                 
            </div>

                <br>
                <br>
                <br>
                <br>
                <br>

            <div>
                <div class="d-grid gap-2 col-6 mx-auto">
                    <input id="guardarReserva" type="button"
                        class="btn btn-success btn-send pt-2 btn-block "
                            value="Guardar Reserva" disabled>
                </div>
            </div>

        </div>

        </div>
    </div>


    <div class="footerItem"></div>
    

</body>
</html>


<script type="module">

    import Reserva from '../../Componentes/Reserva/Reserva.js'
    import GenericUtils from '../../Componentes/GenericUtils/GenericUtils.js'

    var lista_servicios = JSON.parse(localStorage.getItem("lista_servicios"));
    var lista_usuarios = JSON.parse(localStorage.getItem("lista_usuarios"));
    var lista_sucursales = JSON.parse(localStorage.getItem("lista_sucursales"));
    var lista_reservas = JSON.parse(localStorage.getItem("lista_reservas"));

    // Accede al objeto "localStorage" que viene nativamente con javascript
    // y obtiene la propiedad que se le indica.
    var Id_Usuario_LS = Number(localStorage.getItem("id_usuario"));
    var id_detalleReserva = 0;

    let total_reserva = 0;                                                                                                        
    
    // var id_reserva = 0;
    var Id_Reserva_LS = GenericUtils.getLastId("lista_reservas", "id_reserva");


    // #region Jquery - On document ready

    $(document).ready(function() {

        if(Id_Usuario_LS <= 0 || Id_Usuario_LS == null || Id_Usuario_LS == undefined) {

            window.location.href = "../Login.html";

            return;

        }

        // $("#id_cliente").val(Id_Usuario_LS);
        GenericUtils.addFieldToForm("id_cliente", Id_Usuario_LS, "formReserva");

        console.log({Id_Reserva_LS});


        // Itera sobre la lista de sucursales...
        lista_sucursales.forEach(sucursal => {

            // Si la sucursal está activa llena el select (ComboBox) de las sucursales activas
            if(sucursal.estado_sucursal) {
                
                $('#cmbSucursales').append($('<option>', {
                    value: sucursal.id_sucursal,
                    text: sucursal.nombre_sucursal,
                    sortField: 'text' // Permite que se pueda buscar entre las opciones del tag Select.
                }));

            }

        });

        // console.log({lista_servicios});

        // Itera sobre la lista de sucursales...
        lista_servicios.forEach(servicio => {

            // Si la sucursal está activa llena el select (ComboBox) de las sucursales activas
            if(servicio.estado) {
                
                $('#cmbServicios').append($('<option>', {
                    value: servicio.id,
                    text: servicio.nombre,
                    sortField: 'text' // Permite que se pueda buscar entre las opciones del tag Select.
                }));

            }

        });

        // Setea el día actual en el select (ComboBox) 
        setBookingDate();
        

        // Itera sobre la lista de usuarios...
        lista_usuarios.forEach(element => {

            // para obtener los datos del usuario que correspondan a su id
            // y mostrar su nombre en la esquina superior derecha.
            if (parseInt(Id_Usuario_LS) == parseInt(element.id_usuario)) {

                // Fuente: https://stackoverflow.com/questions/1103172/jquery-change-div-text/1103191
                $("#nombre_usuario").text("Bienvenido " + element.nombre);

            }

        });

    });

    // #endregion


    // #region #cmbSucursales - On change

    $('#cmbSucursales').on('change', function () {
        
        checkIfActivateAddButton();

        if (cmbSucursales.value > 0) {

            activateFields();

            var input = document.getElementById( 'dateDiaReserva' ).value;
            var day = new Date( input ).getUTCDay();


            if (day != 6 && day != 0) {

                $('#cmbHorarioReserva').attr('disabled', false);
                $("#cmbHorarioReserva option[value=" + 3 + "]").attr('disabled', false);

            }

            // Si es sábado
            if (day == 6) {

                $('#cmbHorarioReserva').val("");

                checkIfActivateAddButton();

                $("#cmbHorarioReserva option[value=" + 3 + "]").attr('disabled', 'disabled');

            }

            // Si es domingo
            if (day == 0) {

                $('#cmbHorarioReserva').val("");

                $('#cmbHorarioReserva').attr('disabled', 'disabled');

                checkIfActivateAddButton();

            }

        } else {

            deactivateFields();

        }

    });

    // #endregion

    // #region #cmbServicios - On change

    $('#cmbServicios').on('change', function () {
        
        if (cmbServicios.value > 0) {

            checkIfActivateAddButton();

            // Itera sobre la lista de sucursales...
            lista_servicios.forEach(servicio => {

                // Si la sucursal está activa llena el select (ComboBox) de las sucursales activas
                if(servicio.id == cmbServicios.value) {
                    
                    $('#precio').val(servicio.precio);
                    $('#descripcion').val(servicio.descripcion);

                    // Fuente: https://www.tutorialrepublic.com/faq/how-to-change-the-image-source-using-jquery.php
                    $("#imgServicio").attr("src", `../../Tests/images/${servicio.fotografia}`);

                    console.log(`URL Imagen: ../../Tests/images/${servicio.fotografia}`)

                }

            });

        }

    });

    // #endregion

    // #region #cmbHorarioReserva - On change

    $('#cmbHorarioReserva').on('change', function () {

        checkIfActivateAddButton();

    });

    // #endregion

    // #region #dateDiaReserva - On change

    $('#dateDiaReserva').on('change', function (e) {

        var s = e.target.value;

        // Fuente: https://stackoverflow.com/questions/47032326/how-can-i-disable-particular-date-of-input-type-date-from-javascript
        var day = new Date( e.target.value ).getUTCDay();


        // Si es sábado
        if (day == 6) {

            $('#cmbHorarioReserva').attr('disabled', false);
            $('#cmbHorarioReserva').val("");

            checkIfActivateAddButton();

            $("#cmbHorarioReserva option[value=" + 3 + "]").attr('disabled', 'disabled');

        }

        // Si es domingo
        if (day == 0) {

            $('#cmbHorarioReserva').val("");

            $('#cmbHorarioReserva').attr('disabled', 'disabled');

            checkIfActivateAddButton();
            
        }

        if (day != 6 && day != 0) {

            $('#cmbHorarioReserva').attr('disabled', false);
            $("#cmbHorarioReserva option[value=" + 3 + "]").attr('disabled', false);

        }

    });

    // #endregion



    // #region #guardarServicio o #formReserva - On click o submit

    // $('#guardarServicio').on('click', function () {
    $('#formReserva').submit(function (e) {
        e.preventDefault();

        id_detalleReserva += 1;

        console.log({Id_Reserva_LS});
        console.log({id_detalleReserva});

        var idSucursal = $("#cmbSucursales").val();
        var servicio_nombre = $("#cmbServicios option:selected").text();
        var servicio_precio = $("#precio").val();
        var servicio_idServicio = $("#cmbServicios").val();
        var servicio_diaReserva = $("#dateDiaReserva").val();
        var servicio_idHorario = $("#cmbHorarioReserva").val();
        var servicio_horario = $("#cmbHorarioReserva option:selected").text();


        // Fuente: https://stackoverflow.com/questions/18606305/accessing-formdata-values
        // const data = document.forms['formReserva'].elements;
        // const data = document.forms['formReserva'].elements['inputTypeName'].value;


        // Fuente: https://stackoverflow.com/questions/41995372/how-to-add-rows-in-html-table-using-jquery
        // Fuente: https://stackoverflow.com/questions/5440657/how-to-hide-columns-in-html-table
        let td_1_idReserva = `<td style="display:none;" class="id_reserva">${Id_Reserva_LS + 1}</td>`
        let td_2_idDetalleReserva = `<td hidden class="id_detalleReserva">${id_detalleReserva}</td>`
        let td_3_idSucursal = `<td hidden class="id_sucursal">${idSucursal}</td>`
        let td_4_idCliente = `<td hidden class="id_cliente">${Id_Usuario_LS}</td>`
        let td_5_idServicio = `<td hidden class="id_servicio">${parseInt(servicio_idServicio)}</td>`
        let td_5_servicio = `<td width="30%"class="td_item">${servicio_nombre}</td>`
        let td_6_precio = `<td width="20%"class="precio">${servicio_precio}</td>`
        let td_7_diaReserva = `<td hidden class="dia_reserva">${servicio_diaReserva}</td>`
        let td_8_idHorario = `<td hidden class="horario_reserva">${servicio_idHorario}</td>`
        let td_8_horario = `<td width="50%"class="td_item">${servicio_horario}</td>`
        // let td_5_botonEditar = `<td><button class="btnIcon" onclick="showId('row${Id_Reserva_LS}')"></button></td>`


        let row = `<tr id="row${Id_Reserva_LS}" class="tr_item">`
                    + td_1_idReserva
                    + td_2_idDetalleReserva
                    + td_3_idSucursal
                    + td_4_idCliente
                    + td_5_idServicio
                    + td_5_servicio
                    + td_6_precio
                    + td_7_diaReserva
                    + td_8_idHorario
                    + td_8_horario
                    // + td_5_botonEditar
                + "</tr>";

        $('#tblServicios > tbody:last-child').append(row);

        total_reserva += Number(servicio_precio);


        // Fuente: https://www.tutorialspoint.com/How-to-format-a-number-with-two-decimals-in-JavaScript#:~:text=Use%20the%20toFixed()%20method,the%20right%20of%20the%20decimal. 
        $("#divPrecioTotal").text(`$${Number(total_reserva).toFixed(2)}`);
        $("#total_reserva").val(Number(total_reserva).toFixed(2));

        $('#guardarReserva').prop('disabled', false);

        var test_rows = getTableRows();

        console.log({test_rows});

        resetFields();

    });

    // #endregion


    // #region Métodos - setBookingDate, activateFields, deactivateFields, resetFields, checkIfActivateAddButton

    function setBookingDate() {

        // Fuente: https://stackoverflow.com/questions/12346381/set-date-in-input-type-date
        var now = new Date();

        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);

        var today = now.getFullYear()+"-"+(month)+"-"+(day);

        $('#dateDiaReserva').val(today);

        // Fuente: https://stackoverflow.com/questions/43274559/how-do-i-restrict-past-dates-in-html5-input-type-date
        $('#dateDiaReserva').attr('min', today);

    }

    function activateFields() {
        $('#cmbServicios').prop('disabled', false);
        $('#dateDiaReserva').prop('disabled', false);
        $('#cmbHorarioReserva').prop('disabled', false);
    }

    function deactivateFields() {
        $('#cmbServicios').prop('disabled', 'disabled');
        $('#dateDiaReserva').prop('disabled', 'disabled');
        $('#cmbHorarioReserva').prop('disabled', 'disabled');
        
    }

    function resetFields() {
        $("#cmbServicios").val("");
        $("#cmbHorarioReserva").val("");
        $("#precio").val("1");

        // Fuente: https://stackoverflow.com/questions/13726593/how-to-set-image-src-to-empty
        $('#imgServicio').attr('src', '');

        checkIfActivateAddButton();

        $("#descripcion").val("");

        
    }

    function checkIfActivateAddButton() {
        let cmb_sucursales_value = $("#cmbSucursales").val();
        let cmb_servicios_value = $("#cmbServicios").val();
        let cmb_horario_value = $("#cmbHorarioReserva").val();

        // console.log({cmb_servicios_value});
        // console.log({cmb_sucursales_value});

        if (cmb_sucursales_value > 0 && cmb_servicios_value > 0 && cmb_horario_value > 0) {
            $("#guardarServicio").attr('disabled', false);
            
        } else {
            $("#guardarServicio").attr('disabled', 'disabled');

        }
    }

    // #endregion



    // #region #guardarReserva - On click

    $('#guardarReserva').on('click', function () {

        // Nueva reserva creada por defecto
        var nueva_reserva = new Reserva(1, 1, 2, Id_Usuario_LS, 4, "2022-01-10", "0", 0.00, true);

        var verificacion_guardado = false;

        // Recorre todas las filas de la tabla.
        $('table > tbody  > tr').each(function(index, tr) { 
            // console.log({index});

            var rows = tr.childNodes;

            // Recorre todas las columnas que contiene la fila actual.
            rows.forEach(column => {

                var item = column.className;
                // console.log({item});

                // Recorre las propiedades que tiene el objeto de la clase Reserva.
                for(const T in nueva_reserva) {
                    
                    // console.log({T});

                    // Si las propiedades se llaman igual...
                    if(item == T) {
                        // console.log({T});

                        // Obtiene el valor que tiene
                        var outerText = column.outerText;

                        nueva_reserva[item] = outerText;
                        
                    }
                
                }

            });

            nueva_reserva.total_reserva = $("#total_reserva").val();

            // Guarda en la "base" el objeto creado y devuelve si salió todo bien
            verificacion_guardado = Reserva.saveBooking(nueva_reserva);

        });

        console.log({verificacion_guardado});

        if (verificacion_guardado) {
            alert("Reserva guardada con éxito!!!");
        } else {
            alert("Ocurrió un error al guardar la reserva :/");

        }

    });

    // #endregion


    function getTableRows() {

        var rows;

        $('table > tbody  > tr').each(function(index, tr) { 

            rows = tr.childNodes;
            // console.log({rows});

        });

        return rows;

    }
    


</script>


<script>

    function showId(rowId) {
        console.log({rowId});

        var n = document.getElementById(rowId);
        // var n=document.getElementById(rowId).childNodes[0].value;
        // var p=document.getElementById(rowId).childNodes[1].value;
        
        console.log({n});
        
        alert("n="+n);
        // alert("p="+p);

        $("tr.item").each(function() {
            var quantity1 = $(this).find("input.name").val(),
                quantity2 = $(this).find("input.id").val();
            console.log(quantity1);
            console.log(quantity2);
        });
    }

</script>